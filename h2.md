# H2 Purple rain     

## X) Read and summarize    
**x.1 The Pyramid of Pain**
> <https://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html>
- A pyramid illustrating indicators used to detect an adversary's actions.
- The "pain level" indicates how much pain you will cause the adversary when denying it those indicators.
- <img width="410" height="260" alt="Screenshot 2025-10-30 at 11 43 22" src="https://github.com/user-attachments/assets/01ef0960-b35c-44a9-88c1-808e41e2c804" />      

<br> 

**x.2 The Diamond Model of Intrusion Analysis**
> <https://www.threatintel.academy/wp-content/uploads/2020/07/diamond-model.pdf>
- The *diamond model* is a framework for intrusion analysis, consisting of 4 **core features** used to describe an **event**, which can further be identified as malicious activity. 
- Idea is to deepen the understanding of intrusions to better analyze them.
- <img width="697" height="520" alt="Screenshot 2025-10-30 at 11 42 42" src="https://github.com/user-attachments/assets/b46581b6-5022-4711-afb0-a8c31139ff0f" />


## A) Apache Log
Downloading Apache can be done w:
```
$ sudo apt install apache2
```
Start apache and check that it's running:
```
$ sudo systemctl start apache2
$ systemctl status apache2
```
- <img width="390" height="73" alt="Screenshot 2025-10-30 at 15 28 00" src="https://github.com/user-attachments/assets/a114fd39-8646-4726-add1-3fd0735c9854" />     
- <img width="1055" height="650" alt="Screenshot 2025-10-30 at 15 22 58" src="https://github.com/user-attachments/assets/66a9b891-adfa-4d57-ad68-1e9f90d4023a" />       

Checking the access logs
```
$ cat /var/log/apache2/access.log
```
- <img width="1032" height="192" alt="Screenshot 2025-10-30 at 15 39 40" src="https://github.com/user-attachments/assets/46d80158-3e40-4c8d-83f4-9cbfe9c63c3b" />
- We can see stuff like
  - Who made the request.
  - When the request was made.
  - Type of request.
  - Status code.
  - Size of response.
  - User agent.
**Let's take the first line into consideration**
- Client (us): `127.0.0.1` indicating localhost.
- Request was made on the last thursday of october 2025.
- The `GET / HTTP/1.1` line tells us: Client used the `Get` method for the root document using `HTTP version 1.1`.
- The number after that is the `http status code`. `200` indicating = `OK` (request succeeded).
- Yet another number after the status code tells us the size of the response = `3383 bytes`.
- The hyphen is the `referer` (which is nonexistent on the first line because the request came in directly).
  - An example of the referer can be noted in the second log entry: `"http://localhost/"`
  -  **Q:** What is a referer?
  -  **A:** It indicates to us the **previous website**, which is *linked* to the current website/resource being requested.
- The last piece of information tells us the user agent. Browser & OS details of the client etc..     
<br> 
Sources used:     
<https://www.sumologic.com/blog/apache-access-log>      
<https://www.geeksforgeeks.org/techtips/http-headers-referer/>          



## B) Nmapped
<img width="924" height="324" alt="Screenshot 2025-11-02 at 13 56 13" src="https://github.com/user-attachments/assets/4cf3af6d-99bf-4535-a64a-70f196ba51cd" /> <br> 
The results:
- By using Nmapped with he `-A` flag, it runs multiple advanced detection features at once.
- The scanned host is up (reachable)
- `Port 80` is open (active)
  - We can even see the title and header of the website its serving
- Additionally we can the se hosts operating system and some details regarding it
- From `Network Distance: 0 hop` we can determine that the host we are scanning is on the same network as us. (duhhh it's localhost ðŸ˜‚)
  - **Note:** In many cases the same network might just refer the same *logical network*, se we cannot assume that the host is physically close to us based on this (it's just part of the same broadcast/routing domain).
  - **Also:** Sometimes even though the host is on the same network, we might get `> 0` results. This depends on how the network is set up, like VLANs & NAT and such. (basic networking is outside the scope of this section).     


## C) Scripts
From the output in the previous section, we can see that two scripts were automatically run: `http-title` && `http-server-header`.        
More on this topic: <https://nmap.org/book/nse-usage.html>        

## D) The trail
**" Search for trails of the nmap port scan in the logs "**
- <img width="1038" height="533" alt="Screenshot 2025-11-02 at 15 12 38" src="https://github.com/user-attachments/assets/1c9cac36-942a-42f3-9f94-a11a170c364d" />
I couldn't find anything with the command `$ cat /var/log/apache2/access.log`, so I had to navigate to the directory first.        
And wouldnt you know, there was another version of the file. So I then searched through the file using:
```
$ grep -in 'nmap' ./access.log.1
```
**Explanation:**
- The flag `-i` does a case insensitive search
- The `-n` flag gives us the line numbers.
- (if you need more options, check out `grep man pages`!)

**Analysing:**
- The logs are indicating to us that an `Nmap port scan` was in fact performed.
- This can be determined mostly from the `user agent section` providing more info on the requester.         
- One thing that is standing out to me are the weird ass `http methods` used.
  - Especially the line: `"GET /nmaplowercheck1762084392 ...."`
- Answer to Tero's **question** = *how could you gain the same insight from a much larger log file somewhere else*?:
  - Because I used the `-n` flag in my grep search, I can quickly tell we have at least 30 lines of log entries indicating nmap activity.
  - If you wanted to search another file with *thousands and thousands of log entries*, I guess you could use the same parameters as I used, meaning including the: `-i 'nmap'`, as it outputs only entries including `nmap` (case insensitive).         


## E) Wire sharking
Capturing packets while a portscan is performed.       
I captured around 8 seconds of traffic while port scanning, the capture contains 2332 packets in total.   
First we can see a bunch of attempts in order gather intel on open ports:
- <img width="1049" height="261" alt="Screenshot 2025-11-02 at 18 44 56" src="https://github.com/user-attachments/assets/02801134-f871-407e-ad27-d31455eb4eb0" />
- Each attempt has it's own destination port

**Analyzing**
- <img width="705" height="257" alt="Screenshot 2025-11-02 at 18 58 33" src="https://github.com/user-attachments/assets/03720ff8-0afd-4e3b-beb2-b0816987d9ee" />
- Even though the 'nmap' string doesn't appear anywhere, we can see that that it has been used based on the `HTTP requests` appearing in the capture.
- This is nmap in action trying to gather intelligence.
- While creating a little summary on wireshark, on the `http-request`, we can find interesting information.

These are some of the `get requests` used by `Nmap` while running scripts. 
- I have provided the header used and the script description.
- **/sdk**
  - "Apparently, this is a SOAP request which is used to identify vmware vcenters servers and retrieve their version information."
- **/robots.tx** 
  - Script: `http-git`.
  - "The script checks for disallowed entries in /robots.txt on a web server."
- **/nmaplowercheck1762100293**
  - Using this request, nmap checks if the server is returning a proper 404 error.
    - Meaning, it's learning how the target handles "not found" responses.
  - This knowledge is used to avoid false positives.
  - The number immediately after is just the epoch time.
- **/evox/about**
  - Script: `http-trane-info`
  - This header is used to get information on `Trane Tracer SC` devices.
  - **Q:** What are trane tracer devices?
  - **A:** "Trane Tracer SC is an intelligent field panel for communicating with HVAC equipment controllers deployed across several sectors including commercial facilities and others."
- **/HNAP1**
  - Script: `hnap-info`.
  - "Retrieve hardwares details and configuration information utilizing HNAP."
- **/.git/head**
  - Script: `http-git`
  - Checks for a Git repository found in a website's document root.
  - If it find a `HEAD`-file, it will send more of these get requests.
- Sources
  - <https://nmap.org>
  - <https://infosecwriteups.com/evading-detection-while-using-nmap-69633df091f3>
  - <https://noobfrompitt.github.io/research-nmappacketanalysis/>      


**Example frame 2095**
- <img width="759" height="550" alt="Screenshot 2025-11-02 at 18 30 56" src="https://github.com/user-attachments/assets/31b18de2-0d86-446f-a42b-11d0a7cf283e" />
- We can see the `/nmaplowercheck` in action


**Example frame 2213**
- <img width="863" height="238" alt="Screenshot 2025-11-02 at 19 57 15" src="https://github.com/user-attachments/assets/485a5d1f-a003-4044-9b0b-3ea749150540" />
- Here we can detect that the **NSE (Nmap Scripting Engine)** is in play (from the `User-Agent:` section).
- We also have example of the previously mentioned `/evox/about` header in action.       



## F) Ngrep
**" Capture traffic using ngrep and show the sections including 'nmap' "**        
```
$ sudo ngrep -d lo -iw 'nmap'
```
- The `d flag` is used to specify the interface
- i and w flag are both used with the regex.
- `i flag` = case insensitive
- `"nmap"` = regex to match (when used with the `w flag` we are telling `ngrep` it should match the regex as a word).
- <img width="499" height="76" alt="Screenshot 2025-11-02 at 20 15 28" src="https://github.com/user-attachments/assets/982afc79-cb9c-4d69-9313-dc0e2034f0cf" />
- <img width="1039" height="494" alt="Screenshot 2025-11-02 at 20 15 47" src="https://github.com/user-attachments/assets/c1166439-cc16-4caf-8e87-4d1e853e5a0a" />
- <img width="290" height="42" alt="Screenshot 2025-11-02 at 20 18 34" src="https://github.com/user-attachments/assets/be6b08c4-82b6-4498-8e79-28df046c67d6" />
- Out of **2333 received** packets **24 matched** our regex.        


## G) Agent
**" Change the nmap user agent so that it looks like a regular web browser "**
```
$ nmap --script-args http.useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/58.0.3029.110 Safari/537.3" -A localhost
```
When you run this command, atleast the user-agent wont give you up anymore!      

## H) No user in sight

Lets have a look shall we!
- <img width="1036" height="338" alt="Screenshot 2025-11-02 at 22 25 14" src="https://github.com/user-attachments/assets/60c98a6d-832e-4f6a-9ddd-bae991e8d292" />
- <img width="1036" height="481" alt="Screenshot 2025-11-02 at 22 26 00" src="https://github.com/user-attachments/assets/cad10c28-a275-4360-9fca-3c7cc21f6d34" />
  - `0 matched` !!
- <img width="1035" height="376" alt="Screenshot 2025-11-02 at 22 29 29" src="https://github.com/user-attachments/assets/f0577f25-776e-44cd-9267-81e6de661b79" />
  - As we can see from the the apache logs, we have succesfully spoofed a user agent, and it isn't giving us away anymore.
  - If you don't know anything about Nmap, only one entry is giving it away:
    - <img width="1038" height="42" alt="Screenshot 2025-11-02 at 22 30 17" src="https://github.com/user-attachments/assets/ae048383-17f5-446d-b8c8-083539dc483c" />
    - It's the `nmaplowercheck` we discussed earlier.
- But because we did our homework, we can make an educated guess that nmap was used, based on the `get requests`:
  - `GET /robots.txt` && `GET /.git/HEAD` for example.


## I) LowEr CHeCk

Step 1, locate the piece of code that prints nmap:
- I navigated to the `/usr/share/nmap` directory
- The directory had some files and folder, but I ended up in the `/usr/share/nmap/nselib` directory, as the `nselib` most probably stands for **Nmap Scripting Engine Library**. (or something along those lines anyway)
- The directory had a lot of files:
  - <img width="984" height="475" alt="Screenshot 2025-11-02 at 22 48 31" src="https://github.com/user-attachments/assets/cb862e5a-f76e-4106-8af2-3dc726d8e2bd" />
- So a simple grep will do the trick!
  - <img width="757" height="93" alt="Screenshot 2025-11-02 at 22 48 46" src="https://github.com/user-attachments/assets/43641736-18c3-4621-9d68-e92c00e560bc" />
  - It gave me the file and the line, just like that.
- I also wanted to see what else im working with, so i executed the command
```
$ grep -in nmap http.lua
```
- This so that I could delete it from other places as well if need be.
- <img width="1036" height="405" alt="Screenshot 2025-11-02 at 22 51 28" src="https://github.com/user-attachments/assets/1cad4ccf-9ee6-4ae9-95af-b841911a05a7" />

- The file then got some `sudoedit` action and I navigated to line: `2625`.
- I found the target line and deleted `nmap` from 2 places.
  - <img width="659" height="99" alt="Screenshot 2025-11-02 at 22 53 38" src="https://github.com/user-attachments/assets/ac6630b8-8e97-4b52-b8e0-cc58d6f7b655" />

**But does it work?**
- <img width="1034" height="79" alt="Screenshot 2025-11-02 at 22 59 51" src="https://github.com/user-attachments/assets/d0fcffad-c4ee-4b1e-8248-f795bc1a8895" />
- Peep out the time of the execution `22:59`
- <img width="1116" height="548" alt="Screenshot 2025-11-02 at 23 13 52" src="https://github.com/user-attachments/assets/3bc30b8b-88da-4d0b-b63c-9f9528873f8f" />
- <img width="1119" height="532" alt="Screenshot 2025-11-02 at 23 14 16" src="https://github.com/user-attachments/assets/9bee40a8-8edf-4103-818e-9dcb54f4d12d" />

```
grep -in nmap access.log.1
```
<img width="1038" height="652" alt="Screenshot 2025-11-02 at 23 08 41" src="https://github.com/user-attachments/assets/9233ed9b-3264-440d-aac5-3dccb6b97001" />

```
grep -in nmap access.log
```
<img width="1060" height="651" alt="Screenshot 2025-11-02 at 23 09 33" src="https://github.com/user-attachments/assets/c658cdf5-5e5b-4433-9f80-d592c64c9340" />

### Result
The `nmap` string is no where to be found!
