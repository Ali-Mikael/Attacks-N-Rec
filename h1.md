# H1 sniff
<https://terokarvinen.com/verkkoon-tunkeutuminen-ja-tiedustelu/>   

## X) - Read & Summarize
**Wireshark**
- The leading network sniffer and analyzer.
- Installing wireshark on linux is easy: `$ sudo apt update && sudo apt install wireshark -y`.
- Configure wireshark to allow non-superusers to capture packets.
- Add your user to the wireshark group.
- Now you can run it with the `wireshark` command.
- When you want to sniff traffic you specify an interface to listen to or choose "any".
- If you want to save what you have captured, you can do just that by saving it to a `*.pcap` file.   
<https://terokarvinen.com/wireshark-getting-started/>   

**Network Interface Names on Linux**
- A network interface: in most cases a *physical* or *virtual(software based)* **NIC**.
- The loopback interface used by localhost is a good example of a software based NIC.
- Linux network interfaces are named by systemd.
- The name usually contains the interface type prefix.
- Check your own interfaces with commands
```bash
$ ip a
$ ip route
```    
<https://terokarvinen.com/network-interface-linux/>   


## A) - Linux
Kali already installed we are good to go!     

## B) - Can't fish
*"Prove you can cut your VMs internet connection and plug it back on"*     
**Connection is working:**     
<img width="562" height="211" alt="Screenshot 2025-10-25 at 17 05 10" src="https://github.com/user-attachments/assets/1cfef5a1-6b09-43ed-852b-5681b148deee" />      

**Cut the connection by disconnecting the network adapter:**    
<img width="680" height="175" alt="Screenshot 2025-10-25 at 17 06 45" src="https://github.com/user-attachments/assets/479e8e7f-0072-454d-9618-1191544413e5" />
<img width="682" height="174" alt="Screenshot 2025-10-25 at 17 07 09" src="https://github.com/user-attachments/assets/98709d00-8a21-4c6e-9fe9-00e7e6b18773" />     

**Now we don't have a connection anymore:**    
<img width="591" height="127" alt="Screenshot 2025-10-25 at 17 07 47" src="https://github.com/user-attachments/assets/9c1e5f7e-d35f-42a3-884d-1098d00fe5c6" />     

**Want the connection back?**    
Just plug the network adapter:    
<img width="709" height="384" alt="Screenshot 2025-10-25 at 17 17 02" src="https://github.com/user-attachments/assets/8eae0d9b-7f2c-46dc-ac6b-609936e0ed45" />     
If your host machine is connected to the Wi-Fi choose: `En0: Wi-Fi`     
If your host machine is connected through an Ethernet cable choose: `En3: Ethernet adapter`    
Then save your settings and Voila, you have a connection once more!    


## C) - Wireshark
Kali linux comes with wireshark pre-installed, so capturing traffic is easy:   
<img width="1038" height="102" alt="Screenshot 2025-10-25 at 17 29 36" src="https://github.com/user-attachments/assets/7d41f98e-bd5a-4cfc-b560-3c7f7277578f" />    
<img width="1033" height="567" alt="Screenshot 2025-10-25 at 17 30 21" src="https://github.com/user-attachments/assets/f0ef3f26-8f17-4789-8d7a-27f8a60ae86a" />    
From the traffic flow we can see stuff like:
- We have made a DNS query to get the address of a certain web-server.
- We are sending an `[ACK]` (acknowledgement) packet to a server.
- etc..


## D) - TCP/IP
"Refer to the TCP/IP stack and annotate a packet of your choosing"     
<br> 
**Packet I chose (at random):**    
<img width="763" height="456" alt="Screenshot 2025-10-25 at 17 38 05" src="https://github.com/user-attachments/assets/eb86a9c1-5aed-49ee-9106-00d694f7b157" />     
#### Lets dig in!
First we have to recall the TCP/IP stack. It consists of 4 layers:
- **Network access/Link layer**
- **Internet layer**
- **Transport layer**
- **Application layer**      

**Examine the frame:**
- At the top level we notice a frame summary
  - Stuff like bytes, interface etc..
- **The *Layer 1* (Link) we can examine in the Ethernet II section**
  - <img width="737" height="75" alt="Screenshot 2025-10-25 at 17 51 07" src="https://github.com/user-attachments/assets/d01ffe91-d6b6-45b9-ae02-0366535c472f" />
  - Contains link level information like source and destination MAC.
- **The *Layer 2* (Network) we can examine in the Internet Protocol section**
  - <img width="738" height="150" alt="Screenshot 2025-10-25 at 17 54 50" src="https://github.com/user-attachments/assets/ae93515d-2b5a-4944-9440-5aced28138fc" />
  - This contains global source and destination information (internet level).
  - `Internet Protocol Version 6`, tells us IPv6 is in use.
- **The *Layer 3* (Transport) we can examine in the TCP section**
  - <img width="732" height="345" alt="Screenshot 2025-10-25 at 17 58 17" src="https://github.com/user-attachments/assets/369928f9-28b4-4c04-9bc0-97d638ce7c8f" />
  - This gives us the most insight into the packet itself.
  - Destination port 443 indicates that this is part of a secure HTTPS session.
  - TCP `Flags` section indicates that this is a `TCP Acknowledgement` packet, and as the source is our own address, we can deduce that we are acknowledging received data from a server.
  - The `Acknowledgement number: 279084` means we are acknowledging to the origin server that we have succesfully received *279083 bytes* of data and are waiting for the *279084th* byte next.
- **The *Layer 4* (Application)**
  - Since this frame is only an acknowledgement to a server of received data, it doesn't contain any application payload, so we don't have any L4 information to go off.
  - Normally this could contain stuff like HTTP response/request etc..



## E) - What did we surf?
Wireshark capture we're examining can be downloaded at: <https://terokarvinen.com/verkkoon-tunkeutuminen-ja-tiedustelu/surfing-secure.pcap>     
This is the capture we are working with (it has 283 frames in total):     
<img width="1117" height="680" alt="Screenshot 2025-10-26 at 10 49 26" src="https://github.com/user-attachments/assets/b26501fa-04f1-4abf-bfbf-c7672fed5f0a" />      
- From the first section we can see (among other things) that the DNS-resolver for a certain host @ `192.168.122.7` is making a DNS query to aquire the address of a webserver.      
- The query is being sent to the router of the LAN @ `192.168.122.1`, which in turn is returning the address of the webserver for `www.google.com`. (It *probably* found the record in it's cache).
- **Side note:** Why did I assume `192.168.122.1` is a router? Because the address indicates it, routers (specifically default gateways) usually have the first available address, **plus** every time a packet arrives from the internet, the frame information has the source MAC address of the address `192.168.122.1`
- The host gets the IP-address of google.com (216.58.210.164) and establishes a secure connection using the `QUIC` protocol.     
**Q:** What is *QUIC*?     
**A:** **Quick UPD Internet Connections** is the foundation for `HTTP/3`. It's a replacement for older versions of HTTP that rely on TCP + UDP for reliable & secure comms (both requiring multiple steps to operate). QUIC has built in TCP + TLS functionalities providing reliable packet transfer, security and speed, all wrapped into a single protocol running on top of UPD. **In short**, QUIC "combines speed and security in a single handshake" (GeeksforGeeks 2025).      
- Once the connection is established, the host is trying to access a website through google, and a new query is initiated for the address of the web-server hosting `terokarvinen.com`.        
**Frame 22** is the **response** (to the query):
- <img width="1111" height="519" alt="Screenshot 2025-10-26 at 11 49 26" src="https://github.com/user-attachments/assets/3ffce0a1-f326-426b-90de-4af1cf1cc35e" />
- **Note:** `Domain Name System (response)`
- **And:** `Answers: terokarvinen.com: Type A, class IN, addr: 139.162.131.217`    

The address aquired => `139.162.131.217`, the host is now initiating a connection to the webserver.       

Lets's examine **frame number 23**:
- <img width="1120" height="636" alt="Screenshot 2025-10-26 at 11 54 44" src="https://github.com/user-attachments/assets/9a7a69cb-beb2-4c61-bed3-58ff4298f199" />
- Destination port: 443, indicating HTTPS traffic.
- Flags: `SYN`, indicating a Synchronization packet (the start of the TCP 3-way handshake to establish a reliable connection with the server).

The *capture*, a little summary:
- We can see protocols like: TCP, TLS, ARP, DNS & QUIC in use.
- **Hosts:** By quickly going through the capture, we can see atleast 7 hosts involved.
- **Length:** 283 frames
- **Duration:** ~8 seconds captured.
- **Traffic:** Stuff like **DNS-queries** (to obtain global IP-addresses), **ARP-queries** (to obtain a MAC-address correlating with a IP-address), **TCP connection** establishing and active TCP sessions, actual payloads and acknowledgements to received data etc...      

**Sources:**
- GeeksforGeeks 2025. QUIC protocol. URL: <https://www.geeksforgeeks.org/javascript/quic-protocol/>. Accessed 26.10.25
- Wireshark capture: <https://terokarvinen.com/verkkoon-tunkeutuminen-ja-tiedustelu/surfing-secure.pcap> Accessed 26.10.25      


## G) - What brand is the NIC?
To get the brand of the Network Interface Card, we first have to understand how it's built.     
A NIC gets assigned a MAC address by the manufacturer, often called the physical address, to uniquely identify a machine on a network. The address is *48 bit* long, represented in *12 hexadecimal* digits, divided into *6 octects*.      
**The crucial part:** The first 3 octects (6 hexadecimal digits)/(24 bits) of the address is called the **OUI** (Organizational Unique Identifier), this tells us who made the NIC.     
Let's examine the first frame sent by our host:
- <img width="763" height="145" alt="Screenshot 2025-10-26 at 14 04 57" src="https://github.com/user-attachments/assets/6d6ac267-e6da-4f6b-9ec2-8a2d4996ecf9" />
- Source IPv4 (private address): `192.168.122.7`
- Source MAC address: `52-54-00-2f-e1-e5`

**Now we can look it up:**
- <img width="975" height="764" alt="Screenshot 2025-10-26 at 14 45 30" src="https://github.com/user-attachments/assets/ae71b897-3b25-4d27-8aef-40ae255c0b30" />
- I tried to look it up in a few places but couldn't find anything, probably because the host is using a virtual NIC.
- Some googling confirmed my doubts:
  - <img width="1133" height="203" alt="Screenshot 2025-10-26 at 14 56 01" src="https://github.com/user-attachments/assets/a94ce84b-c069-440f-a7d8-a8e6a7edddcb" />
  - Source: <https://devonhubner.org/KVM_MAC_Address_Generator/>
- And then again (notice the same prefix `52-54-00`)
  - <img width="821" height="385" alt="Screenshot 2025-10-26 at 14 59 56" src="https://github.com/user-attachments/assets/f0300237-8c75-4389-a446-d3d87b35e608" />
  - Source: <https://macaddress.io/faq/how-to-recognise-an-oracle-virtual-machine-by-its-mac-address>
- Because the first site tried to offer Realtek as the answer for some reason, I still wanted to cross it off the list and did some research:
  - <img width="335" height="263" alt="Screenshot 2025-10-26 at 18 42 34" src="https://github.com/user-attachments/assets/b8c395a2-61e2-42a6-bbaa-25b6c3ac5537" />
  - Source: <https://macaddresslookup.io/?search=realtek>
  - <img width="978" height="681" alt="Screenshot 2025-10-26 at 18 43 26" src="https://github.com/user-attachments/assets/b137e54f-bcdd-462c-bff2-7306ce4b9a64" />
  - Source: <https://maclookup.app/vendors/realtek-semiconductor-corp>
  - We can see what prefixes Realtek actually uses.
- This way I could safely discard it and end up with my conclusion:
  - The NIC belonging to host `192.168.122.7` does in fact not have a brand, but is software based, meaning a Virtual NIC offered by KVM in conjuction with QEMU.      



## H) - Where did we go?
Two webservers atleast for what I could find:
- www.google.com & www.terokarvinen.com         


**How did I reach this conclusion?**
- *Exhibit A:* Name query result mapping `www.google.com` to `216.58.210.164`
  - <img width="522" height="98" alt="Screenshot 2025-10-26 at 19 03 25" src="https://github.com/user-attachments/assets/93f79a3d-1241-4c8e-bfeb-73e04a7fce61" />
- *Exhibit B:* Our host sending traffic to `216.58.210.164`
  - <img width="756" height="123" alt="Screenshot 2025-10-26 at 19 02 21" src="https://github.com/user-attachments/assets/8d96c65c-0c35-407f-ad14-46b7253692b1" />
- *Exhibit C:* Name query result mapping `terokarvinen.com` to `139.162.131.217` 
  - <img width="517" height="170" alt="Screenshot 2025-10-26 at 19 07 29" src="https://github.com/user-attachments/assets/12b6e58e-d29f-4a37-9e77-fb6e7f401989" />
- *Exhibit D:* Communications between the host and terokarvinen.com webserver
  - <img width="1079" height="61" alt="Screenshot 2025-10-26 at 19 09 26" src="https://github.com/user-attachments/assets/5551298d-31cc-4882-80e3-810a367c4aae" />
  - <img width="741" height="284" alt="Screenshot 2025-10-26 at 19 08 51" src="https://github.com/user-attachments/assets/cf83679e-a612-4ad8-9c48-81f58b1af54a" />
  - Port 443 indicates HTTPS traffic.
- *Exhibit E:* A DNS query mapping `terokarvinen.goatcounter.com` to a IPv6 address `2a01:4f9:3a:13e0::2`
  - <img width="658" height="170" alt="Screenshot 2025-10-26 at 19 15 35" src="https://github.com/user-attachments/assets/9f60c6be-e499-4618-88b5-161805b0739b" />      


## I) - Analyzing my own traffic
Let's examine the capture:
- <img width="1118" height="673" alt="Screenshot 2025-10-26 at 19 31 21" src="https://github.com/user-attachments/assets/ac3dcd30-3c21-4b22-ba1e-4545f18a562c" />     

***Frame 431:***
- <img width="455" height="101" alt="Screenshot 2025-10-26 at 19 33 55" src="https://github.com/user-attachments/assets/6521d6ca-3c9b-457d-b613-353b4f63aadb" />
- We are getting a DNS response to a query we initiated, mapping www.github.com to `140.82.121.3`      

***Frame 434:***
- <img width="739" height="363" alt="Screenshot 2025-10-26 at 19 39 46" src="https://github.com/user-attachments/assets/8d4162a8-4eb8-497f-9ef2-bf7323a3990d" />
- We are initiating a connection to the webserver hosting www.github.com      

***Frame 470:***
- <img width="738" height="439" alt="Screenshot 2025-10-26 at 19 43 30" src="https://github.com/user-attachments/assets/f9300669-c428-4e02-9b32-63649b713790" />
- We are sending a `client-hello` packet to the server. Part of the TLS handshake.
- **Client hello?** => Effectively *initiating* a secure TLS connection to a webserver using HTTPS.      

***Frame 504:***
- <img width="741" height="256" alt="Screenshot 2025-10-26 at 19 47 18" src="https://github.com/user-attachments/assets/34f8ce80-ab41-477f-a3f6-ef739278e172" />
- <img width="733" height="112" alt="Screenshot 2025-10-26 at 19 47 44" src="https://github.com/user-attachments/assets/6f3de727-b803-4112-865a-7b5be20883b5" />
- Actual data is received from the webserver.
- Src IP: `140.82.121.3` (github.com)
- Dest IP: `191.168.1.117` (our host)
- How do we know we're getting data from the server?
  - `Flags: 0x018 (PSH,ACK)`
  - The server is ackowledging that it received data from us, and sending us http data as indicated by the `push` flag + TLS section:
    - `Encrypted Application Data: xxxxxxxxx` && `[Application Data Protocl: HTTP]`        
     

***Frame 538:***
- <img width="735" height="361" alt="Screenshot 2025-10-26 at 20 02 09" src="https://github.com/user-attachments/assets/b74e80c9-a9e9-4eeb-8709-40888ebc60a4" />
- Source: `host`
- Destination: `webserver`
- `Flags: 0x010 (ACK)`
- We are acknowledging data received from the server (up to `40814 bytes`) and are waiting next for byte number `40815`.     
